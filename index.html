<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>todo</title>
    <meta name="description" content="Open source todo.txt web app with autocomplete">

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://apis.google.com https://accounts.google.com https://*.googleapis.com https://*.google.com; style-src 'self' 'unsafe-inline' https://accounts.google.com; img-src 'self' data:; connect-src 'self' https://*.googleapis.com https://accounts.google.com https://apis.google.com https://www.google.com; frame-src 'self' https://accounts.google.com https://content.googleapis.com https://*.google.com;">

    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-hover: #e8e8e8;
            --bg-selected: #dddddd;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --border: #ddd;
            --accent: #0066cc;
            --accent-hover: #0052a3;
            --prio-a: #dc3545;
            --prio-b: #fd7e14;
            --prio-c: #ffc107;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --topbar-height: 57px; /* H√∂he der TopBar */
            --suggestionbar-height: 45px; /* H√∂he der Suggestion Bar */
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2a2a2a;
                --bg-hover: #333;
                --bg-selected: #444444;
                --text-primary: #e8e8e8;
                --text-secondary: #999;
                --border: #444;
                --accent: #4a9eff;
                --accent-hover: #6ab0ff;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { height: 100%; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-primary); color: var(--text-primary);
            font-size: 16px; line-height: 1.5; height: 100%;
            overflow: hidden; position: relative; overscroll-behavior: none;
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            /* Reihen: TopBar, SuggestionBar (optional), Main Content (scrollt) */
            grid-template-rows: auto auto 1fr;
            height: 100%; position: relative; overflow: hidden;
        }

        #topBar {
            grid-column: 1 / -1; display: flex; align-items: center;
            padding: 8px 16px; background: var(--bg-secondary);
            border-bottom: 1px solid var(--border); position: sticky;
            top: 0; z-index: 200; gap: 8px;
            height: var(--topbar-height);
        }
        #topBar .search-add-box {
            flex-grow: 1; min-width: 150px; position: relative;
            display: flex; align-items: center;
        }
        .search-add-box input {
             width: 100%; padding: 10px; border: 2px solid var(--border);
             background: var(--bg-primary); color: var(--text-primary);
             border-radius: 4px; font-size: 14px;
             padding-right: 40px; /* Platz f√ºr X Button */
             box-sizing: border-box;
        }
        .search-add-box input:focus { outline: none; border-color: var(--accent); }

        .clear-search-btn {
            position: absolute; right: 8px; top: 50%;
            transform: translateY(-50%); background: none; border: none;
            font-size: 18px; color: var(--text-secondary); cursor: pointer;
            padding: 5px; display: none; z-index: 5; line-height: 1;
        }
        .clear-search-btn:hover { color: var(--text-primary); }
        .clear-search-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 1px; border-radius: 50%; }

        .desktop-actions { display: flex; gap: 8px; flex-wrap: nowrap; }
        .burger-btn { display: none; font-size: 24px; padding: 4px 12px; margin-left: auto; }

        #suggestionBar {
            grid-column: 1 / -1; grid-row: 2; display: flex;
            background: var(--bg-secondary); border-bottom: 1px solid var(--border);
            padding: 5px 16px; height: var(--suggestionbar-height);
            overflow: hidden; position: sticky;
            top: var(--topbar-height); z-index: 199;
        }
        .suggestion-column { flex: 1; overflow-x: auto; white-space: nowrap; padding: 0 10px; }
        .suggestion-column::-webkit-scrollbar { display: none; }
        .suggestion-column { -ms-overflow-style: none; scrollbar-width: none; }
        .suggestion-column h4 { font-size: 11px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 2px; font-weight: 600; white-space: normal; }
        .suggestion-column .suggestions { display: flex; gap: 6px; }
        .suggestion-item {
            display: inline-block; padding: 3px 8px; background: var(--bg-primary); /* Angepasst von bg-hover */
            border: 1px solid var(--border); border-radius: 4px; font-size: 13px;
            cursor: pointer; transition: background 0.2s; color: var(--text-primary); /* Textfarbe hinzugef√ºgt */
            /* Stil wie Button */
             /* border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); */
        }
        .suggestion-item:hover { background: var(--bg-selected); border-color: var(--accent); }
        .suggestion-column:not(.has-suggestions) { display: none; } /* Leere Spalte ganz ausblenden */


        #menuPanel {
            display: none; position: fixed; top: 0; right: 0; bottom: 0; width: 280px;
            background: var(--bg-secondary); box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            padding: 60px 20px 20px 20px; flex-direction: column;
            align-items: flex-start; gap: 12px; z-index: 1000; overflow-y: auto;
            overscroll-behavior: contain;
        }
        #menuPanel.menu-open { display: flex; }
        #menuPanel h1 { font-size: 20px; font-weight: 600; margin-bottom: 20px; }
        .close-btn { display: block; position: absolute; top: 10px; right: 10px; font-size: 20px; padding: 4px 10px; background: var(--bg-hover); border: none; }
        #menuPanel .btn, #menuPanel label.btn, #menuPanel a.btn, #menuPanel .sort-controls { width: 100%; text-align: left; }
        #menuPanel .sort-controls { display: flex; flex-direction: column; align-items: flex-start; margin-top: 10px; }
        #menuPanel .sort-controls label { margin-bottom: 4px; font-size: 12px; color: var(--text-secondary); }
        #menuPanel .sort-controls select { padding: 6px 10px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); border-radius: 4px; width: 100%; }

        .btn { padding: 8px 16px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); cursor: pointer; border-radius: 4px; font-size: 14px; transition: all 0.2s; text-decoration: none; display: inline-block; vertical-align: middle; }
        .btn:hover { background: var(--bg-hover); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:focus-visible, .task-item:focus-visible, input:focus-visible, textarea:focus-visible, select:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        .btn:active, .task-item:active, .filter-item:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-danger { background-color: var(--danger); color: white; border-color: var(--danger); }
        .btn-danger:hover { background-color: #c82333; border-color: #bd2130; }

        .sidebar { grid-row: 2 / span 2; background: var(--bg-secondary); border-right: 1px solid var(--border); overflow-y: auto; padding: 16px; }
        .sidebar-section { margin-bottom: 24px; }
        .sidebar-section h3 { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600; }
        .filter-btn, .filter-item { display: flex; justify-content: space-between; align-items: center; width: 100%; text-align: left; padding: 8px 12px; background: none; border: none; color: var(--text-primary); cursor: pointer; border-radius: 4px; margin-bottom: 4px; font-size: 14px; transition: background 0.2s; }
        .filter-btn:hover, .filter-item:hover { background: var(--bg-hover); }
        .filter-btn.active, .filter-item.active { background: var(--accent); color: white; }
        .filter-count { font-size: 12px; color: var(--text-secondary); background: var(--bg-primary); padding: 2px 8px; border-radius: 12px; }
        .filter-item.active .filter-count { background: rgba(255,255,255,0.2); color: white; }

        .main-content {
            grid-row: 3; overflow-y: auto; padding: 0;
            overscroll-behavior: contain; -webkit-overflow-scrolling: touch;
        }

        .task-list-container { padding: 16px 24px; }
        .task-list { display: flex; flex-direction: column; }
        .task-item { display: flex; align-items: flex-start; padding: 12px; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 2px; cursor: default; transition: background 0.2s; }
        .task-item:hover { background: var(--bg-hover); }
        .task-item.selected { background: var(--bg-selected); color: var(--text-primary); }
        .task-item.bulk-selected { background: var(--warning); color: var(--text-primary); }
        .task-item:focus { outline: 2px solid var(--accent); outline-offset: -2px; background: var(--bg-selected); }
        .task-group-header { font-size: 14px; font-weight: 600; padding: 8px 12px; background-color: var(--bg-hover); border-bottom: 1px solid var(--border); margin-top: 24px; border-radius: 4px 4px 0 0; }
        .task-group-header:first-of-type { margin-top: 0; }
        .task-item .task-inner-content.hidden { display: none; }
        .task-item .edit-input { padding: 0; margin: 0; border: none; background: transparent; font-family: inherit; cursor: text; font-size: inherit; width: 100%; color: var(--text-primary); }
        .task-item.selected .edit-input { background: var(--bg-hover); }
        .task-checkbox { margin-right: 12px; margin-top: 2px; cursor: pointer; flex-shrink: 0; }
        .task-content { flex: 1; min-width: 0; cursor: text; position: relative; }
        .task-text { word-break: break-word; overflow-wrap: break-word; max-width: 100%; color: var(--text-primary); }
        .task-text.completed { text-decoration: line-through; opacity: 0.6; }
        .priority { font-weight: 600; margin-right: 4px; }
        .priority-A { color: var(--prio-a); } .priority-B { color: var(--prio-b); } .priority-C { color: var(--prio-c); }
        .project, .context { color: var(--accent); margin: 0 2px; cursor: pointer; border-radius: 3px; padding: 1px 3px; }
        .project:hover, .context:hover { background-color: var(--bg-hover); text-decoration: underline; }
        .task-meta { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

        .bulk-actions-bar { display: none; position: fixed; bottom: 0; z-index: 150; left: 280px; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border); padding: 12px 24px; align-items: center; gap: 16px; }
        .bulk-actions-bar.active { display: flex; }

        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-secondary); }
        input[type="file"] { display: none; }

        @media (max-width: 768px) {
             .app-container { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; }
             .sidebar { display: none; grid-row: auto; } /* Grid Row anpassen, falls n√∂tig */
             #topBar { padding: 8px 10px; }
             #topBar .desktop-actions { display: none; }
             .burger-btn { display: block; }
             #suggestionBar { padding: 5px 10px; top: var(--topbar-height); grid-column: 1 / -1; grid-row: 2;} /* Sicherstellen, dass es unter TopBar bleibt */
             .suggestion-column h4 { font-size: 10px; }
             .suggestion-item { font-size: 12px; padding: 2px 6px; }

             .main-content { grid-row: 3; padding-bottom: calc(16px + env(safe-area-inset-bottom)); }
             .task-list-container { padding: 16px; }

             .bulk-actions-bar { left: 0; right: 0; bottom: 0; padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="topBar">
            <div class="search-add-box">
                <input type="text" id="searchAddInput" class="search-add-input" placeholder="Search, filter, or add a new task...">
                <button class="clear-search-btn" id="clearSearchBtn" aria-label="Clear search" style="display: none;">‚úï</button>
            </div>
            <div class="desktop-actions">
                 <button class="btn" id="helpBtnDesktop">?</button>
                 <button class="btn" id="undoBtnDesktop" disabled>‚Ü∂ undo</button>
                 <button class="btn" id="archiveCompletedBtnDesktop">archive</button>
                 <label for="fileInput" class="btn">import</label>
                 <button class="btn" id="exportBtnDesktop">export</button>
                 <button class="btn" id="clearLocalBtnDesktop">clear</button>
                 <button class="btn" id="gdriveLoginBtnDesktop">connect to G-Drive</button>
                 <button class="btn" id="gdrivePushBtnDesktop" style="display: none;">save to G-Drive</button>
                 <button class="btn" id="gdrivePullBtnDesktop" style="display: none;">load from G-Drive</button>
                 <a href="impressum.html" target="_blank" class="btn">Impressum</a>
                 <a href="datenschutz.html" target="_blank" class="btn">Datenschutz</a>
            </div>
            <button class="btn burger-btn" id="burgerBtn" aria-label="Men√º √∂ffnen" aria-expanded="false">‚ò∞</button>
        </div>

        <div id="suggestionBar" style="display: none;">
            <div class="suggestion-column projects">
                <h4>+ Projects</h4>
                <div class="suggestions" id="projectSuggestions"></div>
            </div>
            <div class="suggestion-column contexts">
                <h4>@ Contexts</h4>
                <div class="suggestions" id="contextSuggestions"></div>
            </div>
        </div>

        <div id="menuPanel">
            <h1>todo</h1>
            <button class="btn" id="helpBtnMobile">?</button>
            <button class="btn" id="undoBtnMobile" disabled>‚Ü∂ undo</button>
            <button class="btn" id="archiveCompletedBtnMobile">archive</button>
            <label for="fileInput" class="btn">import</label>
            <button class="btn" id="exportBtnMobile">export</button>
            <button class="btn" id="clearLocalBtnMobile">clear</button>
            <button class="btn" id="gdriveLoginBtnMobile">connect to G-Drive</button>
            <button class="btn" id="gdrivePushBtnMobile" style="display: none;">save to G-Drive</button>
            <button class="btn" id="gdrivePullBtnMobile" style="display: none;">load from G-Drive</button>
            <a href="impressum.html" target="_blank" class="btn">Impressum</a>
            <a href="datenschutz.html" target="_blank" class="btn">Datenschutz</a>
            <div class="sort-controls">
                <label for="sortSelect">Sort:</label>
                <select id="sortSelect">
                    <option value="default">default</option>
                    <option value="priority">priority</option>
                    <option value="project">project</option>
                    <option value="context">context</option>
                    <option value="due">due</option>
                </select>
            </div>
            <button class="btn close-btn" id="closeMenuBtn" aria-label="Men√º schlie√üen">‚úï</button>
        </div>

        <input type="file" id="fileInput" accept=".txt,text/plain" style="display: none;">

        <aside class="sidebar">
            <section class="sidebar-section">
                <h3>Views</h3>
                <button class="filter-btn" data-view-filter="all">all</button>
                <button class="filter-btn" data-view-filter="open">open</button>
                <button class="filter-btn" data-view-filter="done">done</button>
            </section>
            <section class="sidebar-section">
                <h3>Filter</h3>
                <button class="filter-btn" data-special-filter="no-due">no due</button>
                <button class="filter-btn" data-special-filter="no-project">no project</button>
                <button class="filter-btn" data-special-filter="no-context">no context</button>
                <button class="filter-btn" data-special-filter="no-prio">no prio</button>
            </section>
            <section class="sidebar-section"><h3>Priorities</h3><div id="prioritiesList"></div></section>
            <section class="sidebar-section"><h3>Projects</h3><div id="projectsList"></div></section>
            <section class="sidebar-section"><h3>Contexts</h3><div id="contextsList"></div></section>
        </aside>

        <main class="main-content">
            <div class="task-list-container">
                <div class="task-list" id="taskList"></div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <h3>No tasks</h3><p>Add your first task above</p>
                </div>
            </div>
        </main>

        <footer class="bulk-actions-bar" id="bulkBar">
            <span id="bulkCount">0 selected</span>
            <button class="btn" id="bulkSelectAllBtn">Select All</button>
            <button class="btn" id="bulkDeselectBtn">Deselect</button>
            <button class="btn btn-primary" id="bulkCompleteBtn">Complete</button>
            <button class="btn" id="bulkDeleteBtn">Delete</button>
        </footer>
    </div>

    <script>
        window.onerror = (msg, src, ln, col, err) => { console.error('Global error:', {msg, src, ln, col, err}); alert('An error occurred.'); return true; };
        window.onunhandledrejection = (e) => console.error('Unhandled promise rejection:', e.reason);

        const app = {
            tasks: [], selectedTask: null, searchQuery: '', sortField: 'default', bulkSelected: new Set(),
            undoStack: [], maxUndoSize: 20, isWaitingForPriority: false, saveDebounceTimer: null,
            CLIENT_ID: '533958879265-u2sipqoup3j5fobgfkq1f37r5g8eo7lj.apps.googleusercontent.com', DRIVE_SCOPE: 'https://www.googleapis.com/auth/drive.appdata',
            DRIVE_FILE_ID: null, gapiClient: null, gisTokenClient: null,

            init() {
                console.log('üöÄ Initializing App v2.5.0 (Suggestion Bar)');
                this.loadFromLocalStorage();
                this.loadUIPreferences();
                this.attachEventListeners();
                this.attachEventDelegation();
                this.autocomplete.init(this); // Autocomplete initialisieren
                this.render();
                this.updateSortSelects();
            },

            updateSortSelects() {
                document.getElementById('sortSelect').value = this.sortField;
            },

            loadFromLocalStorage() { try { const d=localStorage.getItem("todoTxtTasks"); if(d){ const e=JSON.parse(d); Array.isArray(e)&&(this.tasks=e) } } catch(d){ console.error("‚ùå Failed to load tasks:",d) } },
            loadUIPreferences() { try { this.sortField=localStorage.getItem("sortField")||"default" } catch(d){ console.error("‚ö†Ô∏è Failed to load UI preferences:",d) } },
            saveToLocalStorage(d=!1) { clearTimeout(this.saveDebounceTimer); const e=()=>{ try { localStorage.setItem("todoTxtTasks",JSON.stringify(this.tasks)) } catch(f){ console.error("‚ùå Failed to save tasks:",f) } }; d?e():this.saveDebounceTimer=setTimeout(e,300) },
            saveUIPreferences() { try { localStorage.setItem("sortField",this.sortField) } catch(d){ console.error("‚ö†Ô∏è Failed to save UI preferences:",d) } },

            attachEventListeners() {
                const searchAddInput = document.getElementById('searchAddInput');
                const clearSearchBtn = document.getElementById('clearSearchBtn');

                searchAddInput.addEventListener('input', (e) => {
                    this.searchQuery = e.target.value; // searchQuery immer aktualisieren
                    if (clearSearchBtn) { clearSearchBtn.style.display = e.target.value ? 'block' : 'none'; }
                    this.autocomplete.handleInput(e); // Autocomplete (Suggestion Bar) behandeln
                    this.render();
                });

                searchAddInput.addEventListener('keydown', (e) => {
                    // Autocomplete f√ºr Pfeiltasten etc. nicht mehr n√∂tig in diesem Modell
                    // if (this.autocomplete.handleKeydown(e)) { e.preventDefault(); return; }
                    if (e.key === 'Enter' && !e.isComposing) {
                        e.preventDefault();
                        const value = searchAddInput.value.trim();
                        const contextTags = Array.from(value.matchAll(/(?:\s|^)(prio:[\w.-]+|is:[\w.-]+|[\+@][\w.-]+)/g)).map(m => m[1]);
                        const taskText = value.replace(/(?:\s|^)(prio:[\w.-]+|is:[\w.-]+|[\+@][\w.-]+)/g, '').trim();
                        if (taskText) {
                            const fullTaskText = `${taskText} ${contextTags.join(' ')}`.trim();
                            this.addTask(fullTaskText);
                            this.searchQuery = ''; // Suchfeld nach Hinzuf√ºgen leeren
                            searchAddInput.value = this.searchQuery;
                            if (clearSearchBtn) { clearSearchBtn.style.display = 'none'; }
                            this.autocomplete.hide(); // Suggestion Bar schlie√üen
                            this.render();
                        }
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                         if (this.autocomplete.active) { this.autocomplete.hide(); }
                         else if (searchAddInput.value !== '') { searchAddInput.value = ''; this.searchQuery = ''; if (clearSearchBtn) clearSearchBtn.style.display = 'none'; this.render(); this.autocomplete.hide(); }
                         else { searchAddInput.blur(); }
                    }
                    if (e.key === 'ArrowDown') { const firstTask = document.querySelector('#taskList .task-item'); if (firstTask) { e.preventDefault(); firstTask.focus(); } }
                });

                if (clearSearchBtn) { clearSearchBtn.addEventListener('click', () => { searchAddInput.value = ''; this.searchQuery = ''; clearSearchBtn.style.display = 'none'; this.render(); this.autocomplete.hide(); searchAddInput.focus(); }); }
                else { console.error("Clear search button not found!"); }

                document.getElementById('sortSelect').addEventListener('change', (e) => this.handleSortChange(e.target.value));

                const addActionListener = (idBase, eventType = 'click', fn) => { const desktopEl = document.getElementById(idBase + 'Desktop'); const mobileEl = document.getElementById(idBase + 'Mobile'); if (typeof fn !== 'function') { console.error(`Error attaching listener: fn for ${idBase} is not a function.`); return; } const boundFn = fn.bind(this); if (desktopEl) desktopEl.addEventListener(eventType, boundFn); if (mobileEl) mobileEl.addEventListener(eventType, boundFn); if (idBase === 'fileInput' && eventType === 'change') { const fileInput = document.getElementById('fileInput'); if (fileInput && !fileInput.dataset.listenerAttached) { fileInput.addEventListener(eventType, boundFn); fileInput.dataset.listenerAttached = 'true'; } } };
                addActionListener('helpBtn', 'click', this.showHelp);
                addActionListener('undoBtn', 'click', this.undo);
                addActionListener('archiveCompletedBtn', 'click', this.archiveCompleted);
                addActionListener('fileInput', 'change', (e) => { this.importFile(e.target.files[0]); e.target.value = ''; });
                addActionListener('exportBtn', 'click', this.exportToFile);
                addActionListener('clearLocalBtn', 'click', this.clearLocalStorage);
                addActionListener('gdriveLoginBtn', 'click', this.handleAuthClick);
                addActionListener('gdrivePushBtn', 'click', this.pushToDrive);
                addActionListener('gdrivePullBtn', 'click', this.pullFromDrive);

                document.getElementById('bulkSelectAllBtn').addEventListener('click', () => this.bulkSelectAll());
                document.getElementById('bulkDeselectBtn').addEventListener('click', () => this.bulkDeselectAll());
                document.getElementById('bulkCompleteBtn').addEventListener('click', () => this.bulkComplete());
                document.getElementById('bulkDeleteBtn').addEventListener('click', () => this.bulkDelete());

                document.getElementById('burgerBtn').addEventListener('click', () => this.toggleMenu());
                document.getElementById('closeMenuBtn').addEventListener('click', () => this.toggleMenu());
                document.addEventListener('click', (e) => { const menu = document.getElementById('menuPanel'); const burgerBtn = document.getElementById('burgerBtn'); if (menu && menu.classList.contains('menu-open')) { if (!e.target.closest('#menuPanel') && e.target !== burgerBtn) { this.toggleMenu(); } } });

                document.addEventListener('keydown', (e) => { if (!!document.querySelector('.edit-input') || this.autocomplete.active) return; const isTyping = e.target.matches('input, textarea'); if (e.key === '/' && !isTyping && document.getElementById('searchAddInput').offsetParent !== null) { e.preventDefault(); document.getElementById('searchAddInput').focus(); } if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !isTyping) { e.preventDefault(); this.undo(); } if ((e.key === 'ArrowUp' || e.key === 'ArrowDown') && !isTyping && document.activeElement !== searchAddInput) { e.preventDefault(); this.navigateTasks(e.key === 'ArrowDown' ? 1 : -1); } if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && !isTyping && this.selectedTask) { e.preventDefault(); this.changePriority(e.key === 'ArrowRight' ? 1 : -1); } if ((e.key === 'Delete' || e.key === 'Backspace') && this.selectedTask && !isTyping) { e.preventDefault(); this.deleteTask(this.selectedTask); } if (e.key === 'x' && this.selectedTask && !isTyping) { e.preventDefault(); this.toggleTask(this.selectedTask); } if (e.key === 'e' && this.selectedTask && !isTyping) { e.preventDefault(); const taskElement = document.querySelector(`[data-task-id="${this.selectedTask}"]`); if(taskElement) this.enterEditMode(taskElement); } if (e.key === 'p' && this.selectedTask && !isTyping) { e.preventDefault(); this.isWaitingForPriority = true; } });
            },

            handleSortChange(newSortValue) { this.sortField = newSortValue; this.saveUIPreferences(); this.updateSortSelects(); this.render(); },
            attachEventDelegation() { const d=document.getElementById("taskList"); d.addEventListener("click",e=>{ if(!!document.querySelector(".edit-input"))return; if(e.target.matches(".project")){ e.stopPropagation(); this.toggleFilter(`+${e.target.textContent.substring(1)}`); return } if(e.target.matches(".context")){ e.stopPropagation(); this.toggleFilter(`@${e.target.textContent.substring(1)}`); return } const f=e.target.closest(".task-item"); if(!f)return; const g=f.dataset.taskId; if(!g)return; e.target.matches(".task-checkbox")?(e.preventDefault(),this.toggleTask(g)):e.target.closest(".task-content")&&(e.ctrlKey||e.metaKey?this.toggleBulkSelect(g):this.enterEditMode(f)) }); const dE=document.querySelector(".sidebar"); if(dE) dE.addEventListener("click",e=>{ const f=e.target.closest("[data-view-filter]"); f&&this.toggleFilter(`is:${f.dataset.viewFilter}`,!0); const g=e.target.closest("[data-special-filter]"); g&&this.toggleFilter(`is:${g.dataset.specialFilter}`); const h=e.target.closest(".filter-item"); h&&(h.dataset.priority&&this.toggleFilter(`prio:${h.dataset.priority}`),h.dataset.project&&this.toggleFilter(`+${h.dataset.project}`),h.dataset.context&&this.toggleFilter(`@${h.dataset.context}`)) }) },
            toggleFilter(d,e=!1) { const f=new Set(this.searchQuery.split(" ").filter(Boolean)),g=d.toLowerCase(); let h=!1; f.forEach(j=>{ j.toLowerCase()===g&&(f.delete(j),h=!0) }); h||((e||d.startsWith("is:"))&&f.forEach(j=>{ j.startsWith("is:")&&f.delete(j) }),d.toLowerCase()!=="is:all"&&f.add(d)); this.searchQuery=Array.from(f).join(" "); document.getElementById("searchAddInput").value=this.searchQuery; this.render() },
            addTask(d) { const e=this.parseTodoLine(d); if(!e||!e.text||!e.text.trim())return; this.saveUndoState(); this.tasks.push(e); this.saveToLocalStorage() },
            enterEditMode(d) { const e=d.dataset.taskId,f=this.tasks.find(k=>k.id===e); if(!f)return; this.selectedTask=e; d.parentElement.querySelectorAll(".selected").forEach(k=>k.classList.remove("selected")); d.classList.add("selected"); const g=d.querySelector(".task-inner-content"); g.classList.add("hidden"); const h=document.createElement("input"); h.type="text"; h.className="edit-input"; h.value=f.raw; g.parentElement.appendChild(h); h.focus(); h.select(); h.addEventListener("input",k=>this.autocomplete.handleInput(k)); h.addEventListener("keydown",k=>{ if(this.autocomplete.handleKeydown(k)){ k.preventDefault(); return } k.key==="Enter"?h.blur():k.key==="Escape"&&(h.removeEventListener("blur",j),this.render()) }); const j=()=>{ this.autocomplete.hide(); const k=h.value.trim(); k&&k!==f.raw&&(this.saveUndoState(),(()=>{ const l=this.parseTodoLine(k); l.id=f.id; f.creationDate&&!l.creationDate&&(l.creationDate=f.creationDate); const m=this.tasks.findIndex(n=>n.id===e); m!==-1&&(this.tasks[m]=l); this.saveToLocalStorage() })()); this.render() }; h.addEventListener("blur",j,{ once:!0 }) },
            setPriority(d) { const e=this.tasks.find(g=>g.id===this.selectedTask); if(!e)return; this.saveUndoState(); let f=e.raw.replace(/^\([A-Z]\)\s/,""); d&&(f=`(${d}) ${f}`); const h=this.parseTodoLine(f); h.id=e.id; const i=this.tasks.findIndex(j=>j.id===e.id); i!==-1&&(this.tasks[i]=h); this.saveToLocalStorage(); this.render() },
            changePriority(d) { const e=this.tasks.find(i=>i.id===this.selectedTask); if(!e)return; const f="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),g=[null,...f],h=g.indexOf(e.priority); let j; d>0?j=(h+1)%g.length:j=(h-1+g.length)%g.length; const k=g[j]; k!==e.priority&&this.setPriority(k) },
            generateUniqueId:()=> `${Date.now().toString(36)}-${Math.random().toString(36).substr(2,9)}`,
            parseTodoLine(d) { const e={ id:this.generateUniqueId(),raw:d.trim(),completed:!1,priority:null,completionDate:null,creationDate:null,text:"",projects:[],contexts:[],metadata:{} }; let f=d.trim(); if(!f)return e; if(f.startsWith("x ")) { e.completed=!0; f=f.substring(2); const i=f.match(/^\d{4}-\d{2}-\d{2}\s/); i&&this.isValidDate(i[0].trim())&&(e.completionDate=i[0].trim(),f=f.substring(i[0].length)) } const g=f.match(/^\(([A-Za-z])\)\s/); g&&(e.priority=g[1].toUpperCase(),f=f.substring(g[0].length)); const h=f.match(/^\d{4}-\d{2}-\d{2}\s/); h&&this.isValidDate(h[0].trim())&&(e.creationDate=h[0].trim(),f=f.substring(h[0].length)); const j=f.match(/\+[\w.-]+/g); j&&(e.projects=[...new Set(j.map(l=>l.substring(1)))]); const k=f.match(/@[\w.-]+/g); k&&(e.contexts=[...new Set(k.map(l=>l.substring(1)))]); const m=f.match(/(\w+):([^\s]+)/g); m&&m.forEach(l=>{ const[n,...o]=l.split(":"); n&&o.length&&(e.metadata[n]=o.join(":")) }); e.text=f; return e },
            isValidDate:(d)=> /^\d{4}-\d{2}-\d{2}$/.test(d)&&(new Date(d)).toISOString().startsWith(d),
            toggleTask(d) { const e=this.tasks.find(f=>f.id===d); if(!e)return; this.saveUndoState(); e.completed=!e.completed; const g=(new Date).toISOString().split("T")[0]; e.raw=e.raw.replace(/^x\s\d{4}-\d{2}-\d{2}\s/,"").trim(); e.completed?(e.completionDate=g,e.raw=`x ${g} ${e.raw}`,this.showNotification("‚úÖ Aufgabe erledigt!")):e.completionDate=null; this.saveToLocalStorage(); this.render() },
            deleteTask(d) { if(!confirm("Delete task?"))return; this.saveUndoState(); this.tasks=this.tasks.filter(e=>e.id!==d); this.selectedTask===d&&(this.selectedTask=null); this.saveToLocalStorage(); this.render() },
            selectTask(d) { this.selectedTask=d; this.render() },
            getFilteredTasks() { let d=[...this.tasks]; const e=this.searchQuery.toLowerCase().split(" ").filter(Boolean); let f="all"; e.includes("is:open")?f="open":e.includes("is:done")&&(f="done"); f==="open"?d=d.filter(h=>!h.completed):f==="done"&&(d=d.filter(h=>h.completed)); let g=d; e.length>0&&(g=d.filter(h=>{ const i=h.raw.toLowerCase(); return e.every(j=>{ if(j.startsWith("prio:"))return h.priority===j.split(":")[1].toUpperCase(); if(j.startsWith("+"))return h.projects.some(k=>k.toLowerCase()===j.substring(1)); if(j.startsWith("@"))return h.contexts.some(k=>k.toLowerCase()===j.substring(1)); if(j==="is:no-due")return!h.metadata.due; if(j==="is:no-project")return h.projects.length===0; if(j==="is:no-context")return h.contexts.length===0; if(j==="is:no-prio")return!h.priority; if(j.startsWith("is:"))return!0; return i.includes(j) }) })); this.selectedTask&&!g.some(h=>h.id===this.selectedTask)&&(this.selectedTask=null); return this.sortTasks(g) },
            sortTasks(d) { const e=[...d]; switch(this.sortField){ case"priority":e.sort((f,g)=>(f.priority||"Z").localeCompare(g.priority||"Z")); break; case"project":e.sort((f,g)=>(f.projects[0]||"\uffff").localeCompare(g.projects[0]||"\uffff")); break; case"context":e.sort((f,g)=>(f.contexts[0]||"\uffff").localeCompare(g.contexts[0]||"\uffff")); break; case"due":e.sort((f,g)=>(f.metadata.due||"9999").localeCompare(g.metadata.due||"9999")); break } return e },
            getGroupValue: (d)=> ({priority:d.priority?`Priority ${d.priority}`:"No Priority",project:d.projects[0]||"No Project",context:d.contexts[0]||"No Context",due:d.metadata.due||"No Due Date"})[this.sortField]||"",
            escapeHtml: (d="")=> d.replace(/[&<>"']/g,e=> ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" })[e]),
            render() { const d=document.getElementById("taskList"),e=document.getElementById("emptyState"),f=this.getFilteredTasks(); if(f.length===0)d.innerHTML="",e.style.display="block"; else { e.style.display="none"; let g=null; const h=i=>i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),j=f.map(i=>{ const k=this.getGroupValue(i),l=this.sortField!=="default"&&g!==k; l&&(g=k); let m=this.escapeHtml(i.text); i.projects.forEach(p=>m=m.replace(new RegExp(`\\+${h(this.escapeHtml(p))}\\b`,"gi"),`<span class="project">+${this.escapeHtml(p)}</span>`)); i.contexts.forEach(p=>m=m.replace(new RegExp(`@${h(this.escapeHtml(p))}\\b`,"gi"),`<span class="context">@${this.escapeHtml(p)}</span>`)); const n=[i.creationDate,i.metadata.due,i.completionDate].filter(Boolean).join(" ‚Ä¢ "),o=l?`<h4 class="task-group-header">${this.escapeHtml(k)}</h4>`:""; return`
                            ${o}
                            <div class="task-item ${this.selectedTask===i.id?"selected":""} ${this.bulkSelected.has(i.id)?"bulk-selected":""}" data-task-id="${i.id}" tabindex="-1"> {/* tabindex hinzugef√ºgt */}
                                <input type="checkbox" class="task-checkbox" ${i.completed?"checked":""} aria-label="Toggle task: ${this.escapeHtml(i.text)}">
                                <div class="task-content">
                                    <div class="task-inner-content">
                                        <div class="task-text ${i.completed?"completed":""}">${i.priority?`<span class="priority priority-${i.priority}">(${i.priority})</span> `:""}${m}</div>
                                        ${n?`<div class="task-meta">${n}</div>`:""}
                                    </div>
                                </div>
                            </div>` }).join(""); d.innerHTML=j } this.renderSidebar() },
            renderSidebar() { const d=i=>i.reduce((j,k)=>{ j[k]=(j[k]||0)+1; return j }, {}); const e=d(this.tasks.map(i=>i.priority).filter(Boolean)); const prioList = document.getElementById("prioritiesList"); if(prioList) prioList.innerHTML = Object.entries(e).sort().map(([i,j])=> `<div class="filter-item" data-priority="${i}"><span>(${i})</span><span class="filter-count">${j}</span></div>`).join(""); const f=d(this.tasks.flatMap(i=>i.projects)); const projList = document.getElementById("projectsList"); if(projList) projList.innerHTML = Object.entries(f).sort().map(([i,j])=> `<div class="filter-item" data-project="${this.escapeHtml(i)}"><span>+${this.escapeHtml(i)}</span><span class="filter-count">${j}</span></div>`).join(""); const g=d(this.tasks.flatMap(i=>i.contexts)); const ctxList = document.getElementById("contextsList"); if(ctxList) ctxList.innerHTML = Object.entries(g).sort().map(([i,j])=> `<div class="filter-item" data-context="${this.escapeHtml(i)}"><span>@${this.escapeHtml(i)}</span><span class="filter-count">${j}</span></div>`).join(""); const h=new Set(this.searchQuery.toLowerCase().split(" ").filter(Boolean)); document.querySelectorAll(".sidebar .filter-btn").forEach(i=>{ const{ viewFilter:j,specialFilter:k }=i.dataset; let l=!1; j?(m=h.has("is:open"),n=h.has("is:done"),j==="all"?l=!m&&!n:j==="open"?l=m:j==="done"&&(l=n)):k&&(l=h.has(`is:${k}`)); i.classList.toggle("active",l) }); document.querySelectorAll(".sidebar .filter-item").forEach(i=>{ const{ priority:j,project:k,context:l }=i.dataset; let m=!1; j?m=h.has(`prio:${j.toLowerCase()}`):k?m=h.has(`+${k.toLowerCase()}`):l&&(m=h.has(`@${l.toLowerCase()}`)); i.classList.toggle("active",m) }) },
            toggleBulkSelect(d) { this.bulkSelected.has(d)?this.bulkSelected.delete(d):this.bulkSelected.add(d); this.render(); this.updateBulkBar() },
            bulkSelectAll() { this.getFilteredTasks().forEach(d=>this.bulkSelected.add(d.id)); this.render(); this.updateBulkBar() },
            bulkDeselectAll() { this.bulkSelected.clear(); this.render(); this.updateBulkBar() },
            bulkComplete() { if (this.bulkSelected.size === 0) return; this.saveUndoState(); this.tasks.forEach(t => { if (this.bulkSelected.has(t.id)) this.toggleTask(t.id); }); const count = this.bulkSelected.size; this.bulkSelected.clear(); this.updateBulkBar(); this.showNotification(`‚úÖ ${count} Aufgaben umgeschaltet`); },
            bulkDelete() { if (this.bulkSelected.size === 0 || !confirm(`Delete ${this.bulkSelected.size} task(s)?`)) return; this.saveUndoState(); const count = this.bulkSelected.size; this.tasks = this.tasks.filter(t => !this.bulkSelected.has(t.id)); if (this.selectedTask && this.bulkSelected.has(this.selectedTask)) this.selectedTask = null; this.bulkSelected.clear(); this.saveToLocalStorage(); this.render(); this.updateBulkBar(); this.showNotification(`üóëÔ∏è ${count} Aufgaben gel√∂scht`); },
            navigateTasks(d) { const e=this.getFilteredTasks(); if(e.length===0)return; const f=this.selectedTask?e.findIndex(h=>h.id===this.selectedTask):-1,g=(f+d+e.length)%e.length; const h=e[g]; this.selectTask(h.id); setTimeout(()=>{ const i=document.querySelector(`[data-task-id="${h.id}"]`); i&&i.focus() },50) },
            updateBulkBar() { const d=document.getElementById("bulkBar"),e=this.bulkSelected.size; e>0?(d.classList.add("active"),document.getElementById("bulkCount").textContent=`${e} selected`):d.classList.remove("active") },
            importFile(d) { if (!d || d.size > 1048576 && !confirm(`Large file (${(d.size / 1024 / 1024).toFixed(2)}MB). Continue?`)) return; const e = new FileReader; e.onload = f => { let g = f.target.result; if (g.charCodeAt(0) === 65279) g = g.slice(1); const h = g.split("\n").filter(i => i.trim()); if (this.tasks.length > 0 && !confirm(`Import ${h.length} tasks? (Will append)`)) return; this.saveUndoState(); this.tasks.push(...h.map(i => this.parseTodoLine(i))); this.saveToLocalStorage(true); this.render(); this.showNotification(`‚úÖ Imported ${h.length} tasks`); }; e.readAsText(d); },
            exportToFile() { if (this.tasks.length === 0) return alert("No tasks to export"); const d = this.tasks.map(g => g.raw).join("\n"), e = new Blob([d], { type: "text/plain;charset=utf-8" }), f = URL.createObjectURL(e), h = document.createElement("a"); h.href = f; h.download = `todo-${(new Date).toISOString().slice(0, 10)}.txt`; h.click(); URL.revokeObjectURL(f); },
            archiveCompleted() { const d = this.tasks.filter(g => g.completed); if (d.length === 0 || !confirm(`Archive ${d.length} completed task(s)?`)) return; this.saveUndoState(); const e = d.map(g => g.raw).join("\n"), f = new Blob([e], { type: "text/plain;charset=utf-8" }), i = URL.createObjectURL(f), j = document.createElement("a"); j.href = i; j.download = `done-${(new Date).toISOString().slice(0, 10)}.txt`; j.click(); URL.revokeObjectURL(i); this.tasks = this.tasks.filter(g => !g.completed); if (this.selectedTask && !this.tasks.some(g => g.id === this.selectedTask)) this.selectedTask = null; this.bulkSelected.clear(); this.saveToLocalStorage(); this.render(); this.updateBulkBar(); this.showNotification(`‚úÖ Archived ${d.length} tasks`); },
            clearLocalStorage() { if (confirm('Clear all local tasks?\n\nThis cannot be undone and will NOT affect your Google Drive file.')) { this.tasks = []; this.selectedTask = null; this.bulkSelected.clear(); this.undoStack = []; try { localStorage.removeItem('todoTxtTasks'); } catch (e) { console.error('Failed to remove tasks from localStorage:', e); } this.updateUndoButton(); this.render(); this.showNotification('üóëÔ∏è Local tasks cleared.'); } },
            saveUndoState() { this.undoStack.push(JSON.parse(JSON.stringify(this.tasks))); if (this.undoStack.length > this.maxUndoSize) this.undoStack.shift(); this.updateUndoButton(); },
            updateUndoButton() { const d=this.undoStack.length===0,e=document.getElementById("undoBtnDesktop"),f=document.getElementById("undoBtnMobile"); e&&(e.disabled=d); f&&(f.disabled=d) },
            undo() { if (this.undoStack.length === 0) return; this.tasks = this.undoStack.pop(); this.saveToLocalStorage(); this.render(); this.updateUndoButton(); },
            showHelp() { alert("KEYBOARD SHORTCUTS:\n\n/ - Focus search/add\n‚Üë ‚Üì - Navigate tasks\n‚Üê ‚Üí - Change priority\ne - Edit selected\nx - Toggle done\np then A-Z - Set priority\n(Ctrl|Cmd)+Z - Undo\nDelete - Delete selected\nEsc - Clear search/filters\n\nSEARCH SYNTAX:\n\nprio:A\n+project\n@context\nis:open / is:done\nis:no-due"); },
            showNotification(d) { const e = document.createElement("div"); e.style.cssText = "position:fixed;top:70px;right:20px;background:var(--success);color:white;padding:12px 20px;border-radius:4px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:9999;animation:slideIn 0.3s ease-out;"; e.textContent = d; document.body.appendChild(e); setTimeout(() => { e.style.animation = "slideOut 0.3s ease-in forwards"; setTimeout(() => e.remove(), 300); }, 2500); },
            toggleMenu() { const d = document.getElementById("menuPanel"), e = document.getElementById("burgerBtn"), f = d.classList.toggle("menu-open"); e.setAttribute("aria-expanded", f); },

            async initGapiClient() { if (typeof gapi === "undefined") { console.error("GAPI script ist nicht geladen."); return; } console.log("Lade GAPI Client-Bibliothek..."); try { await new Promise((d, e) => { gapi.load("client", { callback: d, onerror: e, timeout: 5e3, ontimeout: e }); }); console.log("GAPI Client-Bibliothek geladen. Lade Drive API-Definitionen..."); await gapi.client.load("https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"); this.gapiClient = gapi.client; console.log("GAPI Client (Drive) initialisiert."); } catch (d) { console.error("Fehler beim GAPI Init:", d); alert("Fehler: Google Drive API konnte nicht geladen werden."); } },
            initGisTokenClient(d) { if (this.gisTokenClient) { d && d(); return; } if (typeof google === "undefined" || !google.accounts || !google.accounts.oauth2) { console.error("GIS script ist nicht geladen."); alert("Fehler: Google Login-Service konnte nicht geladen werden."); return; } console.log("Initialisiere GIS Token Client..."); try { this.gisTokenClient = google.accounts.oauth2.initTokenClient({ client_id: this.CLIENT_ID, scope: this.DRIVE_SCOPE, callback: e => { if (e.error) { console.error("GIS Error:", e.error); alert(`Login-Fehler: ${e.error}`); return; } if (this.gapiClient) { this.gapiClient.setToken(e); console.log("GIS Token an GAPI √ºbergeben."); } else { console.error("GAPI Client nicht bereit, Token kann nicht gesetzt werden."); alert("Fehler: Drive-Client nicht bereit."); return; } console.log("GIS Login erfolgreich, Token erhalten."); this.updateSyncUI(true); this.findOrCreateDriveFile(); } }); console.log("GIS Token Client initialisiert."); d && d(); } catch (e) { console.error("Fehler beim GIS Init:", e); alert("Fehler beim Initialisieren des Google Logins."); } },
            async handleAuthClick() { if (typeof gapi === "undefined" || typeof google === "undefined") { alert("Google-API-Skripte sind noch nicht geladen. Bitte Moment warten und erneut klicken."); return; } if (!this.gapiClient) { console.log("User-Klick: Initialisiere GAPI (Drive) Client..."); await this.initGapiClient(); if (!this.gapiClient) { console.error("GAPI Client-Initialisierung fehlgeschlagen. Breche ab."); return; } } if (!this.gisTokenClient) { console.log("GAPI ist bereit. Initialisiere GIS (Login) Client..."); this.initGisTokenClient(() => { console.log("GIS ist bereit. Fordere Token an..."); this.gisTokenClient.requestAccessToken(); }); } else { console.log("GAPI und GIS sind bereit. Fordere Token an..."); this.gisTokenClient.requestAccessToken(); } },
            updateSyncUI(d) { const e = d ? "none" : "inline-block", f = d ? "inline-block" : "none"; ["gdriveLoginBtn", "gdrivePushBtn", "gdrivePullBtn"].forEach(g => { const h = document.getElementById(g + "Desktop"), i = document.getElementById(g + "Mobile"), j = g === "gdriveLoginBtn" ? e : f; h && (h.style.display = j); i && (i.style.display = j); }); },
            async findOrCreateDriveFile() { if (!this.gapiClient) { console.warn("GAPI nicht bereit f√ºr Dateisuche."); return; } console.log("Suche nach todo.txt in appDataFolder..."); try { const d = await this.gapiClient.drive.files.list({ spaces: "appDataFolder", fields: "files(id, name)", q: "name='todo.txt'" }); const e = d.result.files; if (e && e.length > 0) { this.DRIVE_FILE_ID = e[0].id; console.log(`Datei gefunden mit ID: ${this.DRIVE_FILE_ID}`); } else { console.log("Keine todo.txt gefunden. Erstelle neue Datei..."); const f = await this.gapiClient.drive.files.create({ resource: { name: "todo.txt", parents: ["appDataFolder"] }, fields: "id" }); this.DRIVE_FILE_ID = f.result.id; console.log(`Neue Datei erstellt mit ID: ${this.DRIVE_FILE_ID}`); } } catch (d) { console.error("Fehler beim Suchen/Erstellen der Drive-Datei:", d); } },
            async pushToDrive() { if (!this.DRIVE_FILE_ID) { alert("Fehler: Keine Datei-ID. Bitte neu verbinden."); return; } if (!this.gapiClient) { alert("Fehler: GAPI Client nicht bereit."); return; } if (!confirm("Lokale Daten ‚ûî Google Drive speichern?\n(√úberschreibt die Cloud-Version)")) return; console.log(`PUSH zu GDrive ${this.DRIVE_FILE_ID}...`); const d = this.tasks.map(f => f.raw).join("\n"); try { await this.gapiClient.request({ path: `/upload/drive/v3/files/${this.DRIVE_FILE_ID}`, method: "PATCH", params: { uploadType: "media" }, body: d }); this.showNotification("‚úÖ In Google Drive gespeichert"); } catch (e) { console.error("Fehler beim PUSH:", e); } },
            async pullFromDrive() { if (!this.DRIVE_FILE_ID) { alert("Fehler: Keine Datei-ID. Bitte neu verbinden."); return; } if (!this.gapiClient) { alert("Fehler: GAPI Client nicht bereit."); return; } if (this.tasks.length > 0 && !confirm("Google Drive ‚ûî Lokale Daten laden?\n(√úberschreibt alle ungespeicherten lokalen √Ñnderungen)")) return; console.log(`PULL von GDrive ${this.DRIVE_FILE_ID}...`); try { const d = await this.gapiClient.drive.files.get({ fileId: this.DRIVE_FILE_ID, alt: "media" }); const e = d.body; this.saveUndoState(); if (e) { this.tasks = e.split("\n").filter(f => f.trim()).map(f => this.parseTodoLine(f)); } else { this.tasks = []; } this.saveToLocalStorage(true); this.render(); this.showNotification("‚úÖ Von Google Drive geladen"); } catch (d) { console.error("Fehler beim PULL:", d); } },

            // --- autocomplete OBJEKT (v6 - Suggestion Bar) ---
            autocomplete: {
                app: null,
                suggestionBar: null,
                projectSuggestionsEl: null,
                contextSuggestionsEl: null,
                active: false,
                targetInput: null,
                triggerInfo: null, // { trigger, query, baseValue }

                init(mainApp) {
                    this.app = mainApp;
                    this.suggestionBar = document.getElementById('suggestionBar');
                    this.projectSuggestionsEl = document.getElementById('projectSuggestions');
                    this.contextSuggestionsEl = document.getElementById('contextSuggestions');
                    this.targetInput = document.getElementById('searchAddInput');

                    this.suggestionBar.addEventListener('click', (e) => {
                        if (e.target.classList.contains('suggestion-item')) {
                            this.confirmSelection(e.target.dataset.value);
                        }
                    });

                    document.addEventListener('click', (e) => {
                         if (this.active && this.suggestionBar && !this.suggestionBar.contains(e.target) && e.target !== this.targetInput) {
                              const clickedInSearchBox = e.target.closest('.search-add-box');
                              if (!clickedInSearchBox) { this.hide(); }
                         }
                    });

                     this.targetInput.addEventListener('blur', (e) => {
                          setTimeout(() => {
                               const relatedTargetIsInBar = document.activeElement && this.suggestionBar && this.suggestionBar.contains(document.activeElement);
                               if (!relatedTargetIsInBar) { this.hide(); }
                          }, 150);
                     });

                      this.targetInput.addEventListener('focus', (e) => {
                         this.handleInput({ target: this.targetInput });
                     });
                },

                handleInput(e) {
                    this.targetInput = e.target;
                    const input = this.targetInput;
                    const value = input.value;
                    const cursorPos = input.selectionStart;

                    if (cursorPos !== value.length) { this.hide(); return; } // Nur am Ende pr√ºfen

                    const valueBeforeCursor = value.substring(0, cursorPos);
                    const match = valueBeforeCursor.match(/([+@])([\w.-]*)$/);

                    if (match) {
                        const trigger = match[1];
                        const query = match[2] || "";
                        const baseValue = valueBeforeCursor.substring(0, valueBeforeCursor.length - query.length);
                        this.triggerInfo = { trigger, query, baseValue };

                        const source = trigger === '+' ? this.app.tasks.flatMap(t => t.projects) : this.app.tasks.flatMap(t => t.contexts);
                        const suggestions = [...new Set(source)]
                            .filter(item => item.toLowerCase().startsWith(query.toLowerCase()))
                            .sort()
                            .slice(0, 10); // Max 10

                        if (suggestions.length > 0) {
                            this.show(trigger, suggestions);
                        } else { this.hide(); }
                    } else { this.triggerInfo = null; this.hide(); }
                },

                handleKeydown(e) {
                    // Keine Tastatursteuerung der Vorschl√§ge mehr n√∂tig
                    return false;
                },

                show(trigger, suggestions) {
                    if (!this.projectSuggestionsEl || !this.contextSuggestionsEl || !this.suggestionBar) return;
                    const projectCol = this.suggestionBar.querySelector('.suggestion-column.projects');
                    const contextCol = this.suggestionBar.querySelector('.suggestion-column.contexts');
                    const createSuggestionHTML = (item) => `<button class="suggestion-item" data-value="${this.app.escapeHtml(item)}">${this.app.escapeHtml(item)}</button>`;

                    if (trigger === '+') {
                        this.projectSuggestionsEl.innerHTML = suggestions.map(createSuggestionHTML).join('');
                        this.contextSuggestionsEl.innerHTML = '';
                        projectCol.style.display = 'block'; // Sicherstellen, dass sichtbar
                        contextCol.style.display = 'none'; // Andere ausblenden
                        projectCol.classList.add('has-suggestions'); // F√ºr eventuelles Styling
                        contextCol.classList.remove('has-suggestions');
                    } else { // trigger === '@'
                        this.contextSuggestionsEl.innerHTML = suggestions.map(createSuggestionHTML).join('');
                        this.projectSuggestionsEl.innerHTML = '';
                        contextCol.style.display = 'block';
                        projectCol.style.display = 'none';
                        contextCol.classList.add('has-suggestions');
                        projectCol.classList.remove('has-suggestions');
                    }
                    this.suggestionBar.style.display = 'flex';
                    this.active = true;
                },

                hide() {
                    if (!this.active || !this.suggestionBar) return;
                    this.active = false;
                    this.suggestionBar.style.display = 'none';
                    this.triggerInfo = null;
                },

                confirmSelection(selectedValue) {
                    if (!this.targetInput || !this.triggerInfo) return;
                    const { baseValue, query } = this.triggerInfo;
                    const newValue = baseValue + selectedValue + ' ';
                    this.targetInput.value = newValue;
                    this.hide();
                    this.targetInput.focus();
                    const newCursorPos = newValue.length;
                    this.targetInput.setSelectionRange(newCursorPos, newCursorPos);
                    this.app.searchQuery = this.targetInput.value;
                    this.targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                },

                updateSelectionUI() {}, // Nicht mehr ben√∂tigt
                positionEl() {} // Nicht mehr ben√∂tigt
            }, // --- ENDE autocomplete OBJEKT ---
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
