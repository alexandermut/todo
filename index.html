<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>todo</title>
    <meta name="description" content="Open source todo.txt web app with autocomplete">

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>

    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://apis.google.com https://accounts.google.com https://*.googleapis.com https://*.google.com; style-src 'self' 'unsafe-inline' https://accounts.google.com; img-src 'self' data:; connect-src 'self' https://*.googleapis.com https://accounts.google.com https://apis.google.com https://www.google.com; frame-src 'self' https://accounts.google.com https://content.googleapis.com https://*.google.com;">

    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-hover: #e8e8e8;
            --bg-selected: #dddddd;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --border: #ddd;
            --accent: #0066cc;
            --accent-hover: #0052a3;
            --prio-a: #dc3545;
            --prio-b: #fd7e14;
            --prio-c: #ffc107;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --topbar-height: 57px; /* Höhe der TopBar */
            --suggestionbar-height: 45px; /* Höhe der Suggestion Bar */
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2a2a2a;
                --bg-hover: #333;
                --bg-selected: #444444;
                --text-primary: #e8e8e8;
                --text-secondary: #999;
                --border: #444;
                --accent: #4a9eff;
                --accent-hover: #6ab0ff;
            }
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { height: 100%; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-primary); color: var(--text-primary);
            font-size: 16px; line-height: 1.5; height: 100%;
            overflow: hidden; position: relative; overscroll-behavior: none;
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            /* Reihen: TopBar, SuggestionBar (optional), Main Content (scrollt) */
            grid-template-rows: auto auto 1fr;
            height: 100%; position: relative; overflow: hidden;
        }

        #topBar {
            grid-column: 1 / -1; /* Volle Breite */
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky; /* Sticky Top */
            top: 0;
            z-index: 200;
            gap: 8px; /* Abstand zwischen Suche und Burger/Actions */
            height: var(--topbar-height); /* Feste Höhe */
        }
        #topBar .search-add-box {
            flex-grow: 1; /* Nimmt meisten Platz ein */
            min-width: 150px; /* Mindestbreite */
            position: relative; /* Für X Button */
            display: flex; /* Für X Button Positionierung */
            align-items: center;
        }
        .search-add-box input {
             width: 100%; padding: 10px; border: 2px solid var(--border);
             background: var(--bg-primary); color: var(--text-primary);
             border-radius: 4px; font-size: 14px;
             padding-right: 40px; /* Platz für X Button */
             box-sizing: border-box;
        }
        .search-add-box input:focus { outline: none; border-color: var(--accent); }

        .clear-search-btn {
            position: absolute; right: 8px; top: 50%;
            transform: translateY(-50%); background: none; border: none;
            font-size: 18px; color: var(--text-secondary); cursor: pointer;
            padding: 5px; display: none; z-index: 5; line-height: 1;
        }
        .clear-search-btn:hover { color: var(--text-primary); }
        .clear-search-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 1px; border-radius: 50%; }


        .desktop-actions { display: flex; gap: 8px; flex-wrap: nowrap; }
        .burger-btn { display: none; font-size: 24px; padding: 4px 12px; margin-left: auto; }

        #suggestionBar {
            grid-column: 1 / -1; /* Volle Breite */
            grid-row: 2; /* Unter der TopBar */
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 5px 16px;
            height: var(--suggestionbar-height);
            overflow: hidden; /* Verhindert, dass Vorschläge rauslaufen */
            position: sticky; /* Klebt unter der TopBar */
            top: var(--topbar-height); /* Offset um Höhe der TopBar */
            z-index: 199;
        }
        .suggestion-column {
            flex: 1; overflow-x: auto; white-space: nowrap; padding: 0 10px;
        }
        /* Hide scrollbar visually */
        .suggestion-column::-webkit-scrollbar { display: none; } /* Chrome, Safari, Opera */
        .suggestion-column { -ms-overflow-style: none; scrollbar-width: none; } /* IE, Edge, Firefox */

        .suggestion-column h4 {
            font-size: 11px; text-transform: uppercase; color: var(--text-secondary);
            margin-bottom: 2px; font-weight: 600; white-space: normal;
        }
        .suggestion-column .suggestions { display: flex; gap: 6px; }
        .suggestion-item {
            display: inline-block; padding: 3px 8px; background: var(--bg-hover);
            border: 1px solid var(--border); border-radius: 4px; font-size: 13px;
            cursor: pointer; transition: background 0.2s;
            /* Use button styles for consistency? Or keep distinct? Use button for now */
             border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);
        }
        .suggestion-item:hover {
            background: var(--bg-selected); border-color: var(--accent);
        }
        .suggestion-column:not(.has-suggestions) { /* Leere Spalte ausblenden */
             display: none;
        }


        #menuPanel {
            display: none; position: fixed; top: 0; right: 0; bottom: 0; width: 280px;
            background: var(--bg-secondary); box-shadow: -2px 0 5px rgba(0,0,0,0.2);
            padding: 60px 20px 20px 20px; flex-direction: column;
            align-items: flex-start; gap: 12px; z-index: 1000; overflow-y: auto;
            overscroll-behavior: contain;
        }
        #menuPanel.menu-open { display: flex; }
        #menuPanel h1 { font-size: 20px; font-weight: 600; margin-bottom: 20px; }
        .close-btn { display: block; position: absolute; top: 10px; right: 10px; font-size: 20px; padding: 4px 10px; background: var(--bg-hover); border: none; }
        #menuPanel .btn, #menuPanel label.btn, #menuPanel a.btn, #menuPanel .sort-controls { width: 100%; text-align: left; }
        #menuPanel .sort-controls { display: flex; flex-direction: column; align-items: flex-start; margin-top: 10px; }
        #menuPanel .sort-controls label { margin-bottom: 4px; font-size: 12px; color: var(--text-secondary); }
        #menuPanel .sort-controls select { padding: 6px 10px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); border-radius: 4px; width: 100%; }

        .btn { padding: 8px 16px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); cursor: pointer; border-radius: 4px; font-size: 14px; transition: all 0.2s; text-decoration: none; display: inline-block; vertical-align: middle; }
        .btn:hover { background: var(--bg-hover); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:focus-visible, .task-item:focus-visible, input:focus-visible, textarea:focus-visible, select:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
        .btn:active, .task-item:active, .filter-item:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary:hover { background: var(--accent-hover); }

        .sidebar { grid-row: 2 / span 2; /* Nimmt Platz von SuggestionBar + Main */ background: var(--bg-secondary); border-right: 1px solid var(--border); overflow-y: auto; padding: 16px; }
        .sidebar-section { margin-bottom: 24px; }
        .sidebar-section h3 { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600; }
        .filter-btn, .filter-item { display: flex; justify-content: space-between; align-items: center; width: 100%; text-align: left; padding: 8px 12px; background: none; border: none; color: var(--text-primary); cursor: pointer; border-radius: 4px; margin-bottom: 4px; font-size: 14px; transition: background 0.2s; }
        .filter-btn:hover, .filter-item:hover { background: var(--bg-hover); }
        .filter-btn.active, .filter-item.active { background: var(--accent); color: white; }
        .filter-count { font-size: 12px; color: var(--text-secondary); background: var(--bg-primary); padding: 2px 8px; border-radius: 12px; }
        .filter-item.active .filter-count { background: rgba(255,255,255,0.2); color: white; }

        .main-content {
            grid-row: 3; /* Rutscht eine Reihe nach unten */
            overflow-y: auto; padding: 0;
            overscroll-behavior: contain; -webkit-overflow-scrolling: touch;
        }

        .task-list-container { padding: 16px 24px; }
        .task-list { display: flex; flex-direction: column; }
        .task-item { display: flex; align-items: flex-start; padding: 12px; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 2px; cursor: default; transition: background 0.2s; }
        .task-item:hover { background: var(--bg-hover); }
        .task-item.selected { background: var(--bg-selected); color: var(--text-primary); }
        .task-item.bulk-selected { background: var(--warning); color: var(--text-primary); }
        .task-item:focus { outline: 2px solid var(--accent); outline-offset: -2px; background: var(--bg-selected); }
        .task-group-header { font-size: 14px; font-weight: 600; padding: 8px 12px; background-color: var(--bg-hover); border-bottom: 1px solid var(--border); margin-top: 24px; border-radius: 4px 4px 0 0; }
        .task-group-header:first-of-type { margin-top: 0; }
        .task-item .task-inner-content.hidden { display: none; }
        .task-item .edit-input { padding: 0; margin: 0; border: none; background: transparent; font-family: inherit; cursor: text; font-size: inherit; width: 100%; color: var(--text-primary); }
        .task-item.selected .edit-input { background: var(--bg-hover); }
        .task-checkbox { margin-right: 12px; margin-top: 2px; cursor: pointer; flex-shrink: 0; }
        .task-content { flex: 1; min-width: 0; cursor: text; position: relative; }
        .task-text { word-break: break-word; overflow-wrap: break-word; max-width: 100%; color: var(--text-primary); }
        .task-text.completed { text-decoration: line-through; opacity: 0.6; }
        .priority { font-weight: 600; margin-right: 4px; }
        .priority-A { color: var(--prio-a); } .priority-B { color: var(--prio-b); } .priority-C { color: var(--prio-c); }
        .project, .context { color: var(--accent); margin: 0 2px; cursor: pointer; border-radius: 3px; padding: 1px 3px; }
        .project:hover, .context:hover { background-color: var(--bg-hover); text-decoration: underline; }
        .task-meta { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

        .bulk-actions-bar { display: none; position: fixed; bottom: 0; z-index: 150; left: 280px; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border); padding: 12px 24px; align-items: center; gap: 16px; }
        .bulk-actions-bar.active { display: flex; }

        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-secondary); }
        input[type="file"] { display: none; }

        @media (max-width: 768px) {
             .app-container { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; }
             .sidebar { display: none; }
             #topBar { padding: 8px 10px; }
             #topBar .desktop-actions { display: none; }
             .burger-btn { display: block; }
             #suggestionBar { padding: 5px 10px; top: var(--topbar-height); } /* Korrektes Sticky Top */
             .suggestion-column h4 { font-size: 10px; }
             .suggestion-item { font-size: 12px; padding: 2px 6px; }

             .main-content { grid-row: 3; padding-bottom: calc(16px + env(safe-area-inset-bottom)); } /* Korrekte Reihe */
             .task-list-container { padding: 16px; }

             .bulk-actions-bar { left: 0; right: 0; bottom: 0; padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="topBar">
            <div class="search-add-box">
                <input type="text" id="searchAddInput" class="search-add-input" placeholder="Search, filter, or add a new task...">
                <button class="clear-search-btn" id="clearSearchBtn" aria-label="Clear search" style="display: none;">✕</button>
            </div>
            <div class="desktop-actions">
                 <button class="btn" id="helpBtnDesktop">?</button>
                 <button class="btn" id="undoBtnDesktop" disabled>↶ undo</button>
                 <button class="btn" id="archiveCompletedBtnDesktop">archive</button>
                 <label for="fileInput" class="btn">import</label>
                 <button class="btn" id="exportBtnDesktop">export</button>
                 <button class="btn" id="clearLocalBtnDesktop">clear</button>
                 <button class="btn" id="gdriveLoginBtnDesktop">connect to G-Drive</button>
                 <button class="btn" id="gdrivePushBtnDesktop" style="display: none;">save to G-Drive</button>
                 <button class="btn" id="gdrivePullBtnDesktop" style="display: none;">load from G-Drive</button>
                 <a href="impressum.html" target="_blank" class="btn">Impressum</a>
                 <a href="datenschutz.html" target="_blank" class="btn">Datenschutz</a>
            </div>
            <button class="btn burger-btn" id="burgerBtn" aria-label="Menü öffnen" aria-expanded="false">☰</button>
        </div>

        <div id="suggestionBar" style="display: none;">
            <div class="suggestion-column projects">
                <h4>+ Projects</h4>
                <div class="suggestions" id="projectSuggestions"></div>
            </div>
            <div class="suggestion-column contexts">
                <h4>@ Contexts</h4>
                <div class="suggestions" id="contextSuggestions"></div>
            </div>
        </div>

        <div id="menuPanel">
            <h1>todo</h1>
            <button class="btn" id="helpBtnMobile">?</button>
            <button class="btn" id="undoBtnMobile" disabled>↶ undo</button>
            <button class="btn" id="archiveCompletedBtnMobile">archive</button>
            <label for="fileInput" class="btn">import</label>
            <button class="btn" id="exportBtnMobile">export</button>
            <button class="btn" id="clearLocalBtnMobile">clear</button>
            <button class="btn" id="gdriveLoginBtnMobile">connect to G-Drive</button>
            <button class="btn" id="gdrivePushBtnMobile" style="display: none;">save to G-Drive</button>
            <button class="btn" id="gdrivePullBtnMobile" style="display: none;">load from G-Drive</button>
            <a href="impressum.html" target="_blank" class="btn">Impressum</a>
            <a href="datenschutz.html" target="_blank" class="btn">Datenschutz</a>
            <div class="sort-controls">
                <label for="sortSelect">Sort:</label>
                <select id="sortSelect">
                    <option value="default">default</option>
                    <option value="priority">priority</option>
                    <option value="project">project</option>
                    <option value="context">context</option>
                    <option value="due">due</option>
                </select>
            </div>
            <button class="btn close-btn" id="closeMenuBtn" aria-label="Menü schließen">✕</button>
        </div>

        <input type="file" id="fileInput" accept=".txt,text/plain" style="display: none;">

        <aside class="sidebar">
            <section class="sidebar-section">
                <h3>Views</h3>
                <button class="filter-btn" data-view-filter="all">all</button>
                <button class="filter-btn" data-view-filter="open">open</button>
                <button class="filter-btn" data-view-filter="done">done</button>
            </section>
            <section class="sidebar-section">
                <h3>Filter</h3>
                <button class="filter-btn" data-special-filter="no-due">no due</button>
                <button class="filter-btn" data-special-filter="no-project">no project</button>
                <button class="filter-btn" data-special-filter="no-context">no context</button>
                <button class="filter-btn" data-special-filter="no-prio">no prio</button>
            </section>
            <section class="sidebar-section"><h3>Priorities</h3><div id="prioritiesList"></div></section>
            <section class="sidebar-section"><h3>Projects</h3><div id="projectsList"></div></section>
            <section class="sidebar-section"><h3>Contexts</h3><div id="contextsList"></div></section>
        </aside>

        <main class="main-content">
            <div class="task-list-container">
                <div class="task-list" id="taskList"></div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <h3>No tasks</h3><p>Add your first task above</p>
                </div>
            </div>
        </main>

        <footer class="bulk-actions-bar" id="bulkBar">
            <span id="bulkCount">0 selected</span>
            <button class="btn" id="bulkSelectAllBtn">Select All</button>
            <button class="btn" id="bulkDeselectBtn">Deselect</button>
            <button class="btn btn-primary" id="bulkCompleteBtn">Complete</button>
            <button class="btn" id="bulkDeleteBtn">Delete</button>
        </footer>
    </div>

    <script>
        window.onerror = (msg, src, ln, col, err) => { console.error('Global error:', {msg, src, ln, col, err}); alert('An error occurred.'); return true; };
        window.onunhandledrejection = (e) => console.error('Unhandled promise rejection:', e.reason);

        const app = {
            tasks: [], selectedTask: null, searchQuery: '', sortField: 'default', bulkSelected: new Set(),
            undoStack: [], maxUndoSize: 20, isWaitingForPriority: false, saveDebounceTimer: null,
            CLIENT_ID: '533958879265-u2sipqoup3j5fobgfkq1f37r5g8eo7lj.apps.googleusercontent.com', DRIVE_SCOPE: 'https://www.googleapis.com/auth/drive.appdata',
            DRIVE_FILE_ID: null, gapiClient: null, gisTokenClient: null,

            init() {
                console.log('🚀 Initializing App v2.5.0 (Suggestion Bar)'); // Version angepasst
                this.loadFromLocalStorage();
                this.loadUIPreferences();
                this.attachEventListeners();
                this.attachEventDelegation();
                this.autocomplete.init(this); // Autocomplete initialisieren
                this.render();
                this.updateSortSelects();
            },

            updateSortSelects() {
                document.getElementById('sortSelect').value = this.sortField;
            },

            loadFromLocalStorage() { try { const d = localStorage.getItem("todoTxtTasks"); if (d) { const e = JSON.parse(d); Array.isArray(e) && (this.tasks = e) } } catch (d) { console.error("❌ Failed to load tasks:", d) } },
            loadUIPreferences() { try { this.sortField = localStorage.getItem("sortField") || "default" } catch (d) { console.error("⚠️ Failed to load UI preferences:", d) } },
            saveToLocalStorage(d = !1) { clearTimeout(this.saveDebounceTimer); const e = () => { try { localStorage.setItem("todoTxtTasks", JSON.stringify(this.tasks)) } catch (f) { console.error("❌ Failed to save tasks:", f) } }; d ? e() : this.saveDebounceTimer = setTimeout(e, 300) },
            saveUIPreferences() { try { localStorage.setItem("sortField", this.sortField) } catch (d) { console.error("⚠️ Failed to save UI preferences:", d) } },

            attachEventListeners() {
                const searchAddInput = document.getElementById('searchAddInput');
                const clearSearchBtn = document.getElementById('clearSearchBtn');

                searchAddInput.addEventListener('input', (e) => {
                    this.searchQuery = e.target.value; // searchQuery immer aktualisieren
                    if (clearSearchBtn) { clearSearchBtn.style.display = e.target.value ? 'block' : 'none'; }
                    this.autocomplete.handleInput(e); // Autocomplete (Suggestion Bar) behandeln
                    this.render(); // Nur rendern, wenn nicht Autocomplete aktiv ist? Nein, immer.
                });

                searchAddInput.addEventListener('keydown', (e) => {
                     // Autocomplete für Pfeiltasten etc. nicht mehr nötig in diesem Modell
                    // if (this.autocomplete.handleKeydown(e)) { e.preventDefault(); return; }
                    if (e.key === 'Enter' && !e.isComposing) {
                        e.preventDefault();
                        // Nur hinzufügen, wenn KEIN Autocomplete aktiv ist, um versehentliches Hinzufügen zu vermeiden?
                        // Oder immer hinzufügen? Immer hinzufügen ist konsistenter.
                        const value = searchAddInput.value.trim();
                        const contextTags = Array.from(value.matchAll(/(?:\s|^)(prio:[\w.-]+|is:[\w.-]+|[\+@][\w.-]+)/g)).map(m => m[1]);
                        const taskText = value.replace(/(?:\s|^)(prio:[\w.-]+|is:[\w.-]+|[\+@][\w.-]+)/g, '').trim();
                        if (taskText) {
                            const fullTaskText = `${taskText} ${contextTags.join(' ')}`.trim();
                            this.addTask(fullTaskText);
                            this.searchQuery = ''; // Suchfeld nach Hinzufügen leeren
                            searchAddInput.value = this.searchQuery;
                            if (clearSearchBtn) { clearSearchBtn.style.display = 'none'; }
                            this.autocomplete.hide(); // Suggestion Bar schließen
                            this.render();
                        }
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                         // Wenn Autocomplete aktiv ist, nur Autocomplete schließen
                         if (this.autocomplete.active) {
                             this.autocomplete.hide();
                         }
                         // Wenn Autocomplete NICHT aktiv ist und Text im Feld -> Feld leeren
                         else if (searchAddInput.value !== '') {
                             searchAddInput.value = ''; this.searchQuery = '';
                             if (clearSearchBtn) clearSearchBtn.style.display = 'none';
                             this.render();
                             this.autocomplete.hide(); // Sicherstellen, dass Bar weg ist
                         }
                         // Wenn Feld schon leer -> Fokus verlieren
                         else { searchAddInput.blur(); }
                    }
                     // Pfeil runter zum Springen in die Liste (unverändert)
                    if (e.key === 'ArrowDown') {
                        const firstTask = document.querySelector('#taskList .task-item');
                        if (firstTask) { e.preventDefault(); firstTask.focus(); }
                    }
                });

                if (clearSearchBtn) {
                    clearSearchBtn.addEventListener('click', () => {
                        searchAddInput.value = ''; this.searchQuery = '';
                        clearSearchBtn.style.display = 'none'; this.render();
                        this.autocomplete.hide(); // Bar schließen
                        searchAddInput.focus();
                    });
                } else { console.error("Clear search button not found!"); }

                document.getElementById('sortSelect').addEventListener('change', (e) => this.handleSortChange(e.target.value));

                const addActionListener = (idBase, eventType = 'click', fn) => { /* unverändert */ };
                addActionListener('helpBtn', 'click', this.showHelp);
                addActionListener('undoBtn', 'click', this.undo);
                addActionListener('archiveCompletedBtn', 'click', this.archiveCompleted);
                addActionListener('fileInput', 'change', (e) => { this.importFile(e.target.files[0]); e.target.value = ''; });
                addActionListener('exportBtn', 'click', this.exportToFile);
                addActionListener('clearLocalBtn', 'click', this.clearLocalStorage);
                addActionListener('gdriveLoginBtn', 'click', this.handleAuthClick);
                addActionListener('gdrivePushBtn', 'click', this.pushToDrive);
                addActionListener('gdrivePullBtn', 'click', this.pullFromDrive);

                document.getElementById('bulkSelectAllBtn').addEventListener('click', () => this.bulkSelectAll());
                document.getElementById('bulkDeselectBtn').addEventListener('click', () => this.bulkDeselectAll());
                document.getElementById('bulkCompleteBtn').addEventListener('click', () => this.bulkComplete());
                document.getElementById('bulkDeleteBtn').addEventListener('click', () => this.bulkDelete());

                document.getElementById('burgerBtn').addEventListener('click', () => this.toggleMenu());
                document.getElementById('closeMenuBtn').addEventListener('click', () => this.toggleMenu());
                document.addEventListener('click', (e) => { /* unverändert: schließt Menü bei Klick daneben */ });

                document.addEventListener('keydown', (e) => { /* unverändert */ });
            },

            handleSortChange(newSortValue) { this.sortField = newSortValue; this.saveUIPreferences(); this.updateSortSelects(); this.render(); },
            attachEventDelegation() { /* unverändert */ },
            toggleFilter(filterPart, isViewFilter = false) { /* unverändert */ },
            addTask(text) { const task = this.parseTodoLine(text); if (!task || !task.text || !task.text.trim()) { return; } this.saveUndoState(); this.tasks.push(task); this.saveToLocalStorage(); },
            enterEditMode(taskElement) { /* unverändert */ },
            setPriority(newPriority) { /* unverändert */ },
            changePriority(direction) { /* unverändert */ },
            generateUniqueId: () => `${Date.now().toString(36)}-${Math.random().toString(36).substr(2, 9)}`,
            parseTodoLine(line) { /* unverändert */ },
            isValidDate: (d) => /^\d{4}-\d{2}-\d{2}$/.test(d) && (new Date(d)).toISOString().startsWith(d),
            toggleTask(taskId) { /* unverändert */ },
            deleteTask(taskId) { /* unverändert */ },
            selectTask(taskId) { this.selectedTask = taskId; this.render(); },
            getFilteredTasks() { /* unverändert */ },
            sortTasks(tasks) { /* unverändert */ },
            getGroupValue: (t) => ({ /* unverändert */ })[this.sortField] || "",
            escapeHtml: (text = '') => text.replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" })[m]),
            render() { /* render() Funktion hier komplett einfügen (wichtig: mit tabindex!) */ },
            renderSidebar() { /* renderSidebar() Funktion hier komplett einfügen */ },
            toggleBulkSelect(taskId) { this.bulkSelected.has(taskId) ? this.bulkSelected.delete(taskId) : this.bulkSelected.add(taskId); this.render(); this.updateBulkBar(); },
            bulkSelectAll() { this.getFilteredTasks().forEach(t => this.bulkSelected.add(t.id)); this.render(); this.updateBulkBar(); },
            bulkDeselectAll() { this.bulkSelected.clear(); this.render(); this.updateBulkBar(); },
            bulkComplete() { if (this.bulkSelected.size === 0) return; this.saveUndoState(); this.tasks.forEach(t => { if (this.bulkSelected.has(t.id)) this.toggleTask(t.id); }); const count = this.bulkSelected.size; this.bulkSelected.clear(); this.updateBulkBar(); this.showNotification(`✅ ${count} Aufgaben umgeschaltet`); },
            bulkDelete() { if (this.bulkSelected.size === 0 || !confirm(`Delete ${this.bulkSelected.size} task(s)?`)) return; this.saveUndoState(); const count = this.bulkSelected.size; this.tasks = this.tasks.filter(t => !this.bulkSelected.has(t.id)); if (this.selectedTask && this.bulkSelected.has(this.selectedTask)) this.selectedTask = null; this.bulkSelected.clear(); this.saveToLocalStorage(); this.render(); this.updateBulkBar(); this.showNotification(`🗑️ ${count} Aufgaben gelöscht`); },
            navigateTasks(direction) { const filtered = this.getFilteredTasks(); if (filtered.length === 0) return; const currentIndex = this.selectedTask ? filtered.findIndex(t => t.id === this.selectedTask) : -1; const newIndex = (currentIndex + direction + filtered.length) % filtered.length; const newTaskToSelect = filtered[newIndex]; this.selectTask(newTaskToSelect.id); setTimeout(() => { const taskElement = document.querySelector(`[data-task-id="${newTaskToSelect.id}"]`); if (taskElement) taskElement.focus(); }, 50); },
            updateBulkBar() { const bulkBar = document.getElementById("bulkBar"); const count = this.bulkSelected.size; if (count > 0) { bulkBar.classList.add("active"); document.getElementById("bulkCount").textContent = `${count} selected`; } else { bulkBar.classList.remove("active"); } },
            importFile(file) { /* unverändert */ },
            exportToFile() { /* unverändert */ },
            archiveCompleted() { /* unverändert */ },
            clearLocalStorage() { /* unverändert */ },
            saveUndoState() { /* unverändert */ },
            updateUndoButton() { /* unverändert */ },
            undo() { /* unverändert */ },
            showHelp() { /* unverändert */ },
            showNotification(message) { /* unverändert */ },
            toggleMenu() { /* unverändert */ },
            async initGapiClient() { /* unverändert */ },
            initGisTokenClient(callback) { /* unverändert */ },
            async handleAuthClick() { /* unverändert */ },
            updateSyncUI(isLoggedIn) { /* unverändert */ },
            async findOrCreateDriveFile() { /* unverändert */ },
            async pushToDrive() { /* unverändert */ },
            async pullFromDrive() { /* unverändert */ },

            // --- NEUES autocomplete OBJEKT (v6 - Suggestion Bar) ---
            autocomplete: {
                app: null,
                suggestionBar: null,
                projectSuggestionsEl: null,
                contextSuggestionsEl: null,
                active: false,
                targetInput: null,
                triggerInfo: null, // { trigger, query, baseValue }

                init(mainApp) {
                    this.app = mainApp;
                    this.suggestionBar = document.getElementById('suggestionBar');
                    this.projectSuggestionsEl = document.getElementById('projectSuggestions');
                    this.contextSuggestionsEl = document.getElementById('contextSuggestions');
                    this.targetInput = document.getElementById('searchAddInput');

                    this.suggestionBar.addEventListener('click', (e) => {
                        if (e.target.classList.contains('suggestion-item')) {
                            this.confirmSelection(e.target.dataset.value);
                        }
                    });

                    document.addEventListener('click', (e) => {
                         if (this.active && this.suggestionBar && !this.suggestionBar.contains(e.target) && e.target !== this.targetInput) {
                              const clickedInSearchBox = e.target.closest('.search-add-box');
                              if (!clickedInSearchBox) { this.hide(); }
                         }
                    });

                     this.targetInput.addEventListener('blur', (e) => {
                          setTimeout(() => {
                               const relatedTargetIsInBar = document.activeElement && this.suggestionBar && this.suggestionBar.contains(document.activeElement);
                               if (!relatedTargetIsInBar) { this.hide(); }
                          }, 150);
                     });

                      this.targetInput.addEventListener('focus', (e) => {
                         this.handleInput({ target: this.targetInput });
                     });
                },

                handleInput(e) {
                    this.targetInput = e.target;
                    const input = this.targetInput;
                    const value = input.value;
                    const cursorPos = input.selectionStart;

                    if (cursorPos !== value.length) { this.hide(); return; } // Nur am Ende prüfen

                    const valueBeforeCursor = value.substring(0, cursorPos);
                    const match = valueBeforeCursor.match(/([+@])([\w.-]*)$/);

                    if (match) {
                        const trigger = match[1];
                        const query = match[2] || "";
                        const baseValue = valueBeforeCursor.substring(0, valueBeforeCursor.length - query.length);
                        this.triggerInfo = { trigger, query, baseValue };

                        const source = trigger === '+' ? this.app.tasks.flatMap(t => t.projects) : this.app.tasks.flatMap(t => t.contexts);
                        const suggestions = [...new Set(source)]
                            .filter(item => item.toLowerCase().startsWith(query.toLowerCase()))
                            .sort()
                            .slice(0, 10); // Max 10

                        if (suggestions.length > 0) {
                            this.show(trigger, suggestions);
                        } else { this.hide(); }
                    } else { this.triggerInfo = null; this.hide(); }
                },

                handleKeydown(e) {
                    // Keine Tastatursteuerung der Vorschläge mehr nötig
                    return false;
                },

                show(trigger, suggestions) {
                    if (!this.projectSuggestionsEl || !this.contextSuggestionsEl || !this.suggestionBar) return;
                    const projectCol = this.suggestionBar.querySelector('.suggestion-column.projects');
                    const contextCol = this.suggestionBar.querySelector('.suggestion-column.contexts');
                    const createSuggestionHTML = (item) => `<button class="suggestion-item" data-value="${this.app.escapeHtml(item)}">${this.app.escapeHtml(item)}</button>`;

                    if (trigger === '+') {
                        this.projectSuggestionsEl.innerHTML = suggestions.map(createSuggestionHTML).join('');
                        this.contextSuggestionsEl.innerHTML = '';
                        projectCol.style.display = 'block'; // Sicherstellen, dass sichtbar
                        contextCol.style.display = 'none'; // Andere ausblenden
                        projectCol.classList.add('has-suggestions'); // Für eventuelles Styling
                        contextCol.classList.remove('has-suggestions');
                    } else { // trigger === '@'
                        this.contextSuggestionsEl.innerHTML = suggestions.map(createSuggestionHTML).join('');
                        this.projectSuggestionsEl.innerHTML = '';
                        contextCol.style.display = 'block';
                        projectCol.style.display = 'none';
                        contextCol.classList.add('has-suggestions');
                        projectCol.classList.remove('has-suggestions');
                    }
                    this.suggestionBar.style.display = 'flex';
                    this.active = true;
                },

                hide() {
                    if (!this.active || !this.suggestionBar) return;
                    this.active = false;
                    this.suggestionBar.style.display = 'none';
                    this.triggerInfo = null;
                },

                confirmSelection(selectedValue) {
                    if (!this.targetInput || !this.triggerInfo) return;
                    const { baseValue, query } = this.triggerInfo;
                    const newValue = baseValue + selectedValue + ' ';
                    this.targetInput.value = newValue;
                    this.hide();
                    this.targetInput.focus();
                    const newCursorPos = newValue.length;
                    this.targetInput.setSelectionRange(newCursorPos, newCursorPos);
                    this.app.searchQuery = this.targetInput.value;
                    this.targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                },

                updateSelectionUI() {}, // Nicht mehr benötigt
                positionEl() {} // Nicht mehr benötigt
            }, // --- ENDE autocomplete OBJEKT ---
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
